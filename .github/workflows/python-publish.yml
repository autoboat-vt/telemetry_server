name: Auto-Increment Semantic Version

on:
  push:
    branches: ["main"]

permissions:
  contents: write # Required to push tags

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # 1. Get latest version from git tags
      - name: Get latest version
        id: get_version
        run: |
          git fetch --tags
          LATEST=$(git tag --list --sort=-v:refname "v*" | head -n 1)
          if [[ -z "$LATEST" ]]; then
            echo "VERSION=0.0.0" >> $GITHUB_ENV
          else
            VERSION="${LATEST#v}"
            echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 2. Increment version with patch/minor rollover
      - name: Increment version
        id: increment
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          PATCH=$((PATCH+1))
          if [ $PATCH -gt 9 ]; then
              PATCH=0
              MINOR=$((MINOR+1))
          fi
          if [ $MINOR -gt 9 ]; then
              MINOR=0
              MAJOR=$((MAJOR+1))
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "New version: $NEW_VERSION"

      # 3. Update pyproject.toml
      - name: Update pyproject.toml
        run: python update_version.py

      # 4. Build package
      - name: Build distributions
        run: |
          python -m pip install --upgrade build
          python -m build

      # 5. Publish to PyPI
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}

      # 6. Tag the repository
      - name: Create Git tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag v$NEW_VERSION
          git push origin v$NEW_VERSION
